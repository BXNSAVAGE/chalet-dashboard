<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chalet Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg: #f5f5f7;
      --card: #ffffff;
      --text: #1d1d1f;
      --muted: #86868b;
      --accent: #0071e3;
      --accent-hover: #0077ed;
      --green: #34c759;
      --orange: #ff9500;
      --red: #ff3b30;
      --border: #d2d2d7;
      --radius: 12px;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255,255,255,0.72);
      backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      height: 52px;
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .logo {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    nav {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }

    .nav-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn:hover { background: rgba(0,0,0,0.04); color: var(--text); }
    .nav-btn.active { background: var(--accent); color: #fff; }

    .main-layout {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 16px;
      padding: 16px;
      height: calc(100vh - 52px);
      overflow: hidden;
    }

    @media (max-width: 1200px) {
      .main-layout { grid-template-columns: 1fr; }
      .sidebar-left, .sidebar-right { display: none; }
    }

    .sidebar-left, .sidebar-right {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .card-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-body { padding: 16px; }

    .calendar-container {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .cal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .cal-title {
      font-size: 22px;
      font-weight: 600;
    }

    .cal-nav {
      display: flex;
      gap: 8px;
    }

    .cal-nav button {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cal-nav button:hover { background: var(--bg); }

    .cal-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-bottom: 1px solid var(--border);
    }

    .cal-weekday {
      padding: 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      flex: 1;
      overflow-y: auto;
    }

    .cal-day {
      min-height: 100px;
      border-right: 1px solid #f0f0f0;
      border-bottom: 1px solid #f0f0f0;
      padding: 4px;
      position: relative;
    }

    .cal-day:nth-child(7n) { border-right: none; }
    .cal-day.other-month { background: #fafafa; }
    .cal-day.today { background: rgba(0, 113, 227, 0.05); }

    .day-number {
      font-size: 12px;
      font-weight: 500;
      color: var(--muted);
      padding: 4px 6px;
    }

    .cal-day.today .day-number {
      background: var(--accent);
      color: #fff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .booking-bar {
      margin: 2px 0;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .booking-bar.confirmed { background: var(--green); }
    .booking-bar.pending { background: var(--orange); }
    .booking-bar.cancelled { background: var(--red); }
    .booking-bar.continuation { 
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      opacity: 0.8;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .stat-item:last-child { border-bottom: none; }

    .stat-label { color: var(--muted); font-size: 13px; }
    .stat-value { font-weight: 600; font-size: 18px; }
    .stat-value.green { color: var(--green); }
    .stat-value.orange { color: var(--orange); }

    .upcoming-item {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .upcoming-item:last-child { border-bottom: none; }
    .upcoming-item:hover { background: var(--bg); }

    .upcoming-date {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .upcoming-guest {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .upcoming-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.confirmed { background: rgba(52,199,89,0.15); color: var(--green); }
    .status-badge.pending { background: rgba(255,149,0,0.15); color: var(--orange); }
    .status-badge.paid { background: rgba(52,199,89,0.15); color: var(--green); }

    .quick-action {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .quick-action:hover { background: var(--bg); }

    .quick-action-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .quick-action-icon.blue { background: rgba(0,113,227,0.1); }
    .quick-action-icon.green { background: rgba(52,199,89,0.1); }
    .quick-action-icon.orange { background: rgba(255,149,0,0.1); }

    .quick-action-text { font-weight: 500; }

    .page { display: none; height: calc(100vh - 52px); overflow-y: auto; }
    .page.active { display: block; }

    .page-content { padding: 24px; max-width: 1200px; margin: 0 auto; }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .page-title { font-size: 28px; font-weight: 600; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover { background: var(--accent-hover); }

    .btn-secondary {
      background: #fff;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-secondary:hover { background: var(--bg); }

    .btn-success { background: var(--green); color: #fff; }
    .btn-danger { background: var(--red); color: #fff; }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .data-table th {
      background: var(--bg);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
    }

    .data-table td {
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .data-table tr:hover { background: #fafafa; }
    .data-table tr:last-child td { border-bottom: none; }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal {
      background: var(--card);
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title { font-size: 18px; font-weight: 600; }

    .modal-close {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--bg);
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: #fff;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-textarea { min-height: 100px; resize: vertical; }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .customer-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .customer-card:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(0,113,227,0.1);
    }

    .customer-name { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .customer-info { font-size: 13px; color: var(--muted); }

    .template-item {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-item:hover { border-color: var(--accent); }
    .template-name { font-weight: 600; margin-bottom: 4px; }
    .template-subject { font-size: 13px; color: var(--muted); }

    .email-preview {
      background: #fafafa;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      font-family: Georgia, serif;
      white-space: pre-wrap;
      line-height: 1.8;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
    .empty-state-text { font-size: 16px; }
  </style>
</head>
<body>
  <header>
    <div class="logo">üèîÔ∏è Chalet Dashboard</div>
    <nav>
      <button class="nav-btn active" data-page="dashboard">Kalender</button>
      <button class="nav-btn" data-page="bookings">Buchungen</button>
      <button class="nav-btn" data-page="customers">Kunden</button>
      <button class="nav-btn" data-page="invoices">Rechnungen</button>
      <button class="nav-btn" data-page="emails">E-Mails</button>
    </nav>
  </header>

  <div class="page active" id="dashboardPage">
    <div class="main-layout">
      <div class="sidebar-left">
        <div class="card">
          <div class="card-header">N√§chste Buchungen</div>
          <div id="upcomingBookings"></div>
        </div>
        <div class="card">
          <div class="card-header">Schnellaktionen</div>
          <div class="card-body" style="padding:8px;">
            <div class="quick-action" onclick="openNewBookingModal()">
              <div class="quick-action-icon blue">üìÖ</div>
              <div class="quick-action-text">Neue Buchung</div>
            </div>
            <div class="quick-action" onclick="openNewCustomerModal()">
              <div class="quick-action-icon green">üë§</div>
              <div class="quick-action-text">Neuer Kunde</div>
            </div>
            <div class="quick-action" onclick="navigateTo('invoices')">
              <div class="quick-action-icon orange">üìÑ</div>
              <div class="quick-action-text">Rechnung erstellen</div>
            </div>
          </div>
        </div>
      </div>

      <div class="calendar-container">
        <div class="cal-header">
          <div class="cal-title" id="calTitle">Dezember 2025</div>
          <div class="cal-nav">
            <button id="prevMonth">‚Üê</button>
            <button id="todayBtn">Heute</button>
            <button id="nextMonth">‚Üí</button>
          </div>
        </div>
        <div class="cal-weekdays">
          <div class="cal-weekday">Mo</div>
          <div class="cal-weekday">Di</div>
          <div class="cal-weekday">Mi</div>
          <div class="cal-weekday">Do</div>
          <div class="cal-weekday">Fr</div>
          <div class="cal-weekday">Sa</div>
          <div class="cal-weekday">So</div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>

      <div class="sidebar-right">
        <div class="card">
          <div class="card-header">Statistiken</div>
          <div class="card-body">
            <div class="stat-item">
              <span class="stat-label">Buchungen gesamt</span>
              <span class="stat-value" id="statTotalBookings">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Best√§tigt</span>
              <span class="stat-value green" id="statConfirmed">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ausstehend</span>
              <span class="stat-value orange" id="statPending">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Umsatz</span>
              <span class="stat-value" id="statRevenue">‚Ç¨0</span>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">Offene Rechnungen</div>
          <div id="pendingInvoices"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="page" id="bookingsPage">
    <div class="page-content">
      <div class="page-header">
        <h1 class="page-title">Buchungen</h1>
        <button class="btn btn-primary" onclick="openNewBookingModal()">+ Neue Buchung</button>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>Gast</th>
            <th>Anreise</th>
            <th>Abreise</th>
            <th>Personen</th>
            <th>Betrag</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="bookingsTableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="page" id="customersPage">
    <div class="page-content">
      <div class="page-header">
        <h1 class="page-title">Kunden</h1>
        <button class="btn btn-primary" onclick="openNewCustomerModal()">+ Neuer Kunde</button>
      </div>
      <div id="customersList"></div>
    </div>
  </div>

  <div class="page" id="invoicesPage">
    <div class="page-content">
      <div class="page-header">
        <h1 class="page-title">Rechnungen</h1>
        <button class="btn btn-primary" onclick="openNewInvoiceModal()">+ Neue Rechnung</button>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>Nr.</th>
            <th>Gast</th>
            <th>Zeitraum</th>
            <th>Betrag</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="invoicesTableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="page" id="emailsPage">
    <div class="page-content">
      <div class="page-header">
        <h1 class="page-title">E-Mail Vorlagen</h1>
      </div>
      <div id="emailTemplatesList"></div>
    </div>
  </div>

  <div class="overlay" id="bookingModal">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header">
        <span class="modal-title" id="bookingModalTitle">Neue Buchung</span>
        <button class="modal-close" onclick="closeModal('bookingModal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="bookingId">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Gastname</label>
            <input type="text" class="form-input" id="bookingGuest" placeholder="z.B. Familie M√ºller">
          </div>
          <div class="form-group">
            <label class="form-label">E-Mail</label>
            <input type="email" class="form-input" id="bookingEmail" placeholder="gast@email.com">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Telefon</label>
            <input type="text" class="form-input" id="bookingPhone" placeholder="+43 ...">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="bookingStatus">
              <option value="pending">Ausstehend</option>
              <option value="confirmed">Best√§tigt</option>
              <option value="cancelled">Storniert</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Adresse</label>
          <textarea class="form-textarea" id="bookingAddress" placeholder="Stra√üe, PLZ Ort, Land" rows="2"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Anreise</label>
            <input type="date" class="form-input" id="bookingStart">
          </div>
          <div class="form-group">
            <label class="form-label">Abreise</label>
            <input type="date" class="form-input" id="bookingEnd">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Erwachsene</label>
            <input type="number" class="form-input" id="bookingAdults" min="1" value="2">
          </div>
          <div class="form-group">
            <label class="form-label">Kinder</label>
            <input type="number" class="form-input" id="bookingChildren" min="0" value="0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Gesamtbetrag (‚Ç¨)</label>
            <input type="number" class="form-input" id="bookingAmount" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label class="form-label">Anzahlung (‚Ç¨)</label>
            <input type="number" class="form-input" id="bookingDeposit" step="0.01" value="0">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notizen</label>
          <textarea class="form-textarea" id="bookingNotes" placeholder="Zus√§tzliche Informationen..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('bookingModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="saveBooking()">Speichern</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="customerModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="customerModalTitle">Neuer Kunde</span>
        <button class="modal-close" onclick="closeModal('customerModal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="customerId">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" id="customerName" placeholder="Vollst√§ndiger Name">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">E-Mail</label>
            <input type="email" class="form-input" id="customerEmail">
          </div>
          <div class="form-group">
            <label class="form-label">Telefon</label>
            <input type="text" class="form-input" id="customerPhone">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Adresse</label>
          <textarea class="form-textarea" id="customerAddress" rows="2"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Land</label>
          <input type="text" class="form-input" id="customerCountry" placeholder="z.B. √ñsterreich, Deutschland">
        </div>
        <div class="form-group">
          <label class="form-label">Notizen</label>
          <textarea class="form-textarea" id="customerNotes"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('customerModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="saveCustomer()">Speichern</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="invoiceModal">
    <div class="modal" style="max-width:800px;">
      <div class="modal-header">
        <span class="modal-title">Neue Rechnung</span>
        <button class="modal-close" onclick="closeModal('invoiceModal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Buchung ausw√§hlen</label>
          <select class="form-select" id="invoiceBooking" onchange="fillInvoiceFromBooking()">
            <option value="">-- Buchung w√§hlen --</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Gastname</label>
            <input type="text" class="form-input" id="invoiceGuest">
          </div>
          <div class="form-group">
            <label class="form-label">E-Mail</label>
            <input type="email" class="form-input" id="invoiceEmail">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Anreise</label>
            <input type="date" class="form-input" id="invoiceCheckin">
          </div>
          <div class="form-group">
            <label class="form-label">Abreise</label>
            <input type="date" class="form-input" id="invoiceCheckout">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Erwachsene</label>
            <input type="number" class="form-input" id="invoiceAdults" value="2" onchange="calculateInvoice()">
          </div>
          <div class="form-group">
            <label class="form-label">Kinder</label>
            <input type="number" class="form-input" id="invoiceChildren" value="0">
          </div>
        </div>
        <div style="background:#f5f5f7;border-radius:8px;padding:16px;margin:16px 0;">
          <h4 style="margin-bottom:12px;">Positionen</h4>
          <div id="invoiceItems">
            <div class="form-row" style="margin-bottom:8px;">
              <input type="text" class="form-input" placeholder="Beschreibung" value="Appartment Bischof" style="flex:2;">
              <input type="number" class="form-input" placeholder="Menge" value="1" style="width:80px;" onchange="calculateInvoice()">
              <input type="number" class="form-input" placeholder="Preis" value="0" step="0.01" style="width:100px;" onchange="calculateInvoice()">
            </div>
          </div>
          <button class="btn btn-secondary" onclick="addInvoiceItem()" style="margin-top:8px;">+ Position</button>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Zwischensumme</label>
            <input type="number" class="form-input" id="invoiceSubtotal" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Ortstaxe (‚Ç¨5/Nacht/Erw.)</label>
            <input type="number" class="form-input" id="invoiceTax" readonly>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Endreinigung</label>
            <input type="number" class="form-input" id="invoiceCleaning" value="70">
          </div>
          <div class="form-group">
            <label class="form-label">Gesamtbetrag</label>
            <input type="number" class="form-input" id="invoiceTotal" readonly style="font-weight:bold;">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Anzahlung</label>
            <input type="number" class="form-input" id="invoiceDeposit" value="0" onchange="calculateInvoice()">
          </div>
          <div class="form-group">
            <label class="form-label">Restbetrag</label>
            <input type="number" class="form-input" id="invoiceBalance" readonly style="font-weight:bold;color:var(--accent);">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('invoiceModal')">Abbrechen</button>
        <button class="btn btn-success" onclick="saveInvoice()">Rechnung erstellen</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="emailModal">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header">
        <span class="modal-title" id="emailModalTitle">E-Mail senden</span>
        <button class="modal-close" onclick="closeModal('emailModal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">An</label>
          <input type="email" class="form-input" id="emailTo">
        </div>
        <div class="form-group">
          <label class="form-label">Betreff</label>
          <input type="text" class="form-input" id="emailSubject">
        </div>
        <div class="form-group">
          <label class="form-label">Nachricht</label>
          <div class="email-preview" id="emailBody" contenteditable="true" style="min-height:300px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('emailModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="copyEmail()">üìã Kopieren</button>
      </div>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    
    let bookings = [];
    let customers = [];
    let invoices = [];
    let emailTemplates = [];
    let currentDate = new Date();

    async function init() {
      await Promise.all([
        loadBookings(),
        loadCustomers(),
        loadInvoices(),
        loadEmailTemplates(),
        loadStats()
      ]);
      renderCalendar();
      renderUpcomingBookings();
      renderPendingInvoices();
      setupNavigation();
    }

    async function loadBookings() {
      try {
        const res = await fetch('/api/bookings');
        bookings = await res.json();
        renderBookingsTable();
      } catch (e) {
        console.error('Error loading bookings:', e);
        bookings = [];
      }
    }

    async function loadCustomers() {
      try {
        const res = await fetch('/api/customers');
        customers = await res.json();
        renderCustomersList();
      } catch (e) {
        console.error('Error loading customers:', e);
        customers = [];
      }
    }

    async function loadInvoices() {
      try {
        const res = await fetch('/api/invoices');
        invoices = await res.json();
        renderInvoicesTable();
      } catch (e) {
        console.error('Error loading invoices:', e);
        invoices = [];
      }
    }

    async function loadEmailTemplates() {
      try {
        const res = await fetch('/api/email-templates');
        emailTemplates = await res.json();
        renderEmailTemplates();
      } catch (e) {
        console.error('Error loading templates:', e);
        emailTemplates = [];
      }
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        const stats = await res.json();
        document.getElementById('statTotalBookings').textContent = stats.total_bookings || 0;
        document.getElementById('statConfirmed').textContent = stats.confirmed_bookings || 0;
        document.getElementById('statPending').textContent = stats.pending_bookings || 0;
        document.getElementById('statRevenue').textContent = '‚Ç¨' + parseFloat(stats.total_revenue || 0).toFixed(0);
      } catch (e) {
        console.error('Error loading stats:', e);
      }
    }

    function setupNavigation() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
          document.getElementById(btn.dataset.page + 'Page').classList.add('active');
        });
      });

      document.getElementById('prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
      document.getElementById('nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
      document.getElementById('todayBtn').onclick = () => { currentDate = new Date(); renderCalendar(); };
    }

    function navigateTo(page) {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`).classList.add('active');
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(page + 'Page').classList.add('active');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function formatDateShort(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('de-DE', { day: 'numeric', month: 'short' });
    }

    function renderCalendar() {
      const grid = document.getElementById('calGrid');
      const title = document.getElementById('calTitle');
      
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      title.textContent = new Date(year, month).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startOffset = (firstDay.getDay() + 6) % 7;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let html = '';
      
      for (let i = 0; i < startOffset; i++) {
        const d = new Date(year, month, 1 - startOffset + i);
        html += `<div class="cal-day other-month"><span class="day-number">${d.getDate()}</span></div>`;
      }
      
      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(year, month, d);
        const dateStr = date.toISOString().split('T')[0];
        const isToday = date.getTime() === today.getTime();
        
        html += `<div class="cal-day ${isToday ? 'today' : ''}" data-date="${dateStr}">
          <span class="day-number">${d}</span>`;
        
        bookings.forEach(b => {
          const start = new Date(b.start_date);
          const end = new Date(b.end_date);
          start.setHours(0, 0, 0, 0);
          end.setHours(0, 0, 0, 0);
          
          if (date >= start && date <= end) {
            const isStart = date.getTime() === start.getTime();
            html += `<div class="booking-bar ${b.status} ${isStart ? '' : 'continuation'}" 
                         onclick="openBookingForEdit('${b.id}')">
              ${isStart ? (b.guest_name || 'Gast') : ''}
            </div>`;
          }
        });
        
        html += '</div>';
      }
      
      const remainingDays = 42 - startOffset - lastDay.getDate();
      for (let i = 1; i <= remainingDays; i++) {
        html += `<div class="cal-day other-month"><span class="day-number">${i}</span></div>`;
      }
      
      grid.innerHTML = html;
    }

    function renderUpcomingBookings() {
      const container = document.getElementById('upcomingBookings');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const upcoming = bookings
        .filter(b => new Date(b.start_date) >= today)
        .sort((a, b) => new Date(a.start_date) - new Date(b.start_date))
        .slice(0, 5);
      
      if (upcoming.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:30px;"><div class="empty-state-text">Keine anstehenden Buchungen</div></div>';
        return;
      }
      
      container.innerHTML = upcoming.map(b => `
        <div class="upcoming-item" onclick="openBookingForEdit('${b.id}')">
          <div class="upcoming-date">${formatDateShort(b.start_date)} - ${formatDateShort(b.end_date)}</div>
          <div class="upcoming-guest">${b.guest_name || 'Gast'}</div>
          <div class="upcoming-meta">${b.adults} Erw. ${b.children > 0 ? '+ ' + b.children + ' Kind.' : ''} ¬∑ <span class="status-badge ${b.status}">${b.status === 'confirmed' ? 'Best√§tigt' : 'Ausstehend'}</span></div>
        </div>
      `).join('');
    }

    function renderPendingInvoices() {
      const container = document.getElementById('pendingInvoices');
      const pending = invoices.filter(i => i.status === 'pending').slice(0, 5);
      
      if (pending.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:30px;"><div class="empty-state-text">Keine offenen Rechnungen</div></div>';
        return;
      }
      
      container.innerHTML = pending.map(inv => `
        <div class="upcoming-item">
          <div class="upcoming-date">#${inv.invoice_number}</div>
          <div class="upcoming-guest">${inv.guest_name || 'Gast'}</div>
          <div class="upcoming-meta">‚Ç¨${parseFloat(inv.balance_due || 0).toFixed(2)} offen</div>
        </div>
      `).join('');
    }

    function renderBookingsTable() {
      const tbody = document.getElementById('bookingsTableBody');
      if (bookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--muted);">Keine Buchungen vorhanden</td></tr>';
        return;
      }
      
      tbody.innerHTML = bookings.map(b => `
        <tr>
          <td><strong>${b.guest_name || '-'}</strong><br><small style="color:var(--muted);">${b.email || ''}</small></td>
          <td>${formatDate(b.start_date)}</td>
          <td>${formatDate(b.end_date)}</td>
          <td>${b.adults} Erw. ${b.children > 0 ? '+ ' + b.children + ' Kind.' : ''}</td>
          <td>‚Ç¨${parseFloat(b.amount || 0).toFixed(2)}</td>
          <td><span class="status-badge ${b.status}">${b.status === 'confirmed' ? 'Best√§tigt' : b.status === 'cancelled' ? 'Storniert' : 'Ausstehend'}</span></td>
          <td>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px;" onclick="openBookingForEdit('${b.id}')">Bearbeiten</button>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px;" onclick="sendEmailForBooking('${b.id}')">E-Mail</button>
          </td>
        </tr>
      `).join('');
    }

    function renderCustomersList() {
      const container = document.getElementById('customersList');
      if (customers.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë§</div><div class="empty-state-text">Noch keine Kunden vorhanden</div></div>';
        return;
      }
      
      container.innerHTML = customers.map(c => `
        <div class="customer-card" onclick="openCustomerForEdit('${c.id}')">
          <div class="customer-name">${c.name}</div>
          <div class="customer-info">${c.email || ''} ${c.phone ? '¬∑ ' + c.phone : ''}</div>
          <div class="customer-info" style="margin-top:4px;">${c.country || ''}</div>
        </div>
      `).join('');
    }

    function renderInvoicesTable() {
      const tbody = document.getElementById('invoicesTableBody');
      if (invoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--muted);">Keine Rechnungen vorhanden</td></tr>';
        return;
      }
      
      tbody.innerHTML = invoices.map(inv => `
        <tr>
          <td><strong>#${inv.invoice_number}</strong></td>
          <td>${inv.guest_name || '-'}</td>
          <td>${formatDate(inv.checkin)} - ${formatDate(inv.checkout)}</td>
          <td>‚Ç¨${parseFloat(inv.total || 0).toFixed(2)}</td>
          <td><span class="status-badge ${inv.status}">${inv.status === 'paid' ? 'Bezahlt' : 'Offen'}</span></td>
          <td>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px;" onclick="downloadInvoicePDF('${inv.id}')">PDF</button>
          </td>
        </tr>
      `).join('');
    }

    function renderEmailTemplates() {
      const container = document.getElementById('emailTemplatesList');
      container.innerHTML = emailTemplates.map(t => `
        <div class="template-item" onclick="previewTemplate('${t.id}')">
          <div class="template-name">${t.name}</div>
          <div class="template-subject">${t.subject}</div>
        </div>
      `).join('');
    }

    function openModal(id) {
      document.getElementById(id).style.display = 'flex';
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function openNewBookingModal() {
      document.getElementById('bookingModalTitle').textContent = 'Neue Buchung';
      document.getElementById('bookingId').value = '';
      document.getElementById('bookingGuest').value = '';
      document.getElementById('bookingEmail').value = '';
      document.getElementById('bookingPhone').value = '';
      document.getElementById('bookingAddress').value = '';
      document.getElementById('bookingStatus').value = 'pending';
      document.getElementById('bookingStart').value = '';
      document.getElementById('bookingEnd').value = '';
      document.getElementById('bookingAdults').value = 2;
      document.getElementById('bookingChildren').value = 0;
      document.getElementById('bookingAmount').value = 0;
      document.getElementById('bookingDeposit').value = 0;
      document.getElementById('bookingNotes').value = '';
      openModal('bookingModal');
    }

    function openBookingForEdit(id) {
      const booking = bookings.find(b => b.id === id);
      if (!booking) return;
      
      document.getElementById('bookingModalTitle').textContent = 'Buchung bearbeiten';
      document.getElementById('bookingId').value = id;
      document.getElementById('bookingGuest').value = booking.guest_name || '';
      document.getElementById('bookingEmail').value = booking.email || '';
      document.getElementById('bookingPhone').value = booking.phone || '';
      document.getElementById('bookingAddress').value = booking.address || '';
      document.getElementById('bookingStatus').value = booking.status || 'pending';
      document.getElementById('bookingStart').value = booking.start_date ? booking.start_date.split('T')[0] : '';
      document.getElementById('bookingEnd').value = booking.end_date ? booking.end_date.split('T')[0] : '';
      document.getElementById('bookingAdults').value = booking.adults || 2;
      document.getElementById('bookingChildren').value = booking.children || 0;
      document.getElementById('bookingAmount').value = booking.amount || 0;
      document.getElementById('bookingDeposit').value = booking.deposit_amount || 0;
      document.getElementById('bookingNotes').value = booking.notes || '';
      openModal('bookingModal');
    }

    async function saveBooking() {
      const id = document.getElementById('bookingId').value;
      const data = {
        guest_name: document.getElementById('bookingGuest').value,
        email: document.getElementById('bookingEmail').value,
        phone: document.getElementById('bookingPhone').value,
        address: document.getElementById('bookingAddress').value,
        status: document.getElementById('bookingStatus').value,
        start_date: document.getElementById('bookingStart').value,
        end_date: document.getElementById('bookingEnd').value,
        adults: parseInt(document.getElementById('bookingAdults').value) || 2,
        children: parseInt(document.getElementById('bookingChildren').value) || 0,
        amount: parseFloat(document.getElementById('bookingAmount').value) || 0,
        deposit_amount: parseFloat(document.getElementById('bookingDeposit').value) || 0,
        notes: document.getElementById('bookingNotes').value
      };
      
      try {
        if (id) {
          await fetch(`/api/bookings/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          await fetch('/api/bookings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        closeModal('bookingModal');
        await loadBookings();
        await loadStats();
        renderCalendar();
        renderUpcomingBookings();
      } catch (e) {
        alert('Fehler beim Speichern: ' + e.message);
      }
    }

    function openNewCustomerModal() {
      document.getElementById('customerModalTitle').textContent = 'Neuer Kunde';
      document.getElementById('customerId').value = '';
      document.getElementById('customerName').value = '';
      document.getElementById('customerEmail').value = '';
      document.getElementById('customerPhone').value = '';
      document.getElementById('customerAddress').value = '';
      document.getElementById('customerCountry').value = '';
      document.getElementById('customerNotes').value = '';
      openModal('customerModal');
    }

    function openCustomerForEdit(id) {
      const customer = customers.find(c => c.id === id);
      if (!customer) return;
      
      document.getElementById('customerModalTitle').textContent = 'Kunde bearbeiten';
      document.getElementById('customerId').value = id;
      document.getElementById('customerName').value = customer.name || '';
      document.getElementById('customerEmail').value = customer.email || '';
      document.getElementById('customerPhone').value = customer.phone || '';
      document.getElementById('customerAddress').value = customer.address || '';
      document.getElementById('customerCountry').value = customer.country || '';
      document.getElementById('customerNotes').value = customer.notes || '';
      openModal('customerModal');
    }

    async function saveCustomer() {
      const id = document.getElementById('customerId').value;
      const data = {
        name: document.getElementById('customerName').value,
        email: document.getElementById('customerEmail').value,
        phone: document.getElementById('customerPhone').value,
        address: document.getElementById('customerAddress').value,
        country: document.getElementById('customerCountry').value,
        notes: document.getElementById('customerNotes').value
      };
      
      try {
        if (id) {
          await fetch(`/api/customers/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          await fetch('/api/customers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        closeModal('customerModal');
        await loadCustomers();
      } catch (e) {
        alert('Fehler beim Speichern: ' + e.message);
      }
    }

    function openNewInvoiceModal() {
      const select = document.getElementById('invoiceBooking');
      select.innerHTML = '<option value="">-- Buchung w√§hlen --</option>' + 
        bookings.map(b => `<option value="${b.id}">${b.guest_name || 'Gast'} (${formatDate(b.start_date)})</option>`).join('');
      
      document.getElementById('invoiceGuest').value = '';
      document.getElementById('invoiceEmail').value = '';
      document.getElementById('invoiceCheckin').value = '';
      document.getElementById('invoiceCheckout').value = '';
      document.getElementById('invoiceAdults').value = 2;
      document.getElementById('invoiceChildren').value = 0;
      document.getElementById('invoiceSubtotal').value = 0;
      document.getElementById('invoiceTax').value = 0;
      document.getElementById('invoiceCleaning').value = 70;
      document.getElementById('invoiceTotal').value = 0;
      document.getElementById('invoiceDeposit').value = 0;
      document.getElementById('invoiceBalance').value = 0;
      
      openModal('invoiceModal');
    }

    function fillInvoiceFromBooking() {
      const bookingId = document.getElementById('invoiceBooking').value;
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;
      
      document.getElementById('invoiceGuest').value = booking.guest_name || '';
      document.getElementById('invoiceEmail').value = booking.email || '';
      document.getElementById('invoiceCheckin').value = booking.start_date ? booking.start_date.split('T')[0] : '';
      document.getElementById('invoiceCheckout').value = booking.end_date ? booking.end_date.split('T')[0] : '';
      document.getElementById('invoiceAdults').value = booking.adults || 2;
      document.getElementById('invoiceChildren').value = booking.children || 0;
      document.getElementById('invoiceDeposit').value = booking.deposit_amount || 0;
      
      const items = document.querySelectorAll('#invoiceItems .form-row');
      if (items.length > 0) {
        items[0].querySelectorAll('input')[2].value = booking.amount || 0;
      }
      
      calculateInvoice();
    }

    function calculateInvoice() {
      const checkin = document.getElementById('invoiceCheckin').value;
      const checkout = document.getElementById('invoiceCheckout').value;
      const adults = parseInt(document.getElementById('invoiceAdults').value) || 0;
      
      let nights = 0;
      if (checkin && checkout) {
        nights = Math.round((new Date(checkout) - new Date(checkin)) / (1000 * 60 * 60 * 24));
      }
      
      let subtotal = 0;
      document.querySelectorAll('#invoiceItems .form-row').forEach(row => {
        const inputs = row.querySelectorAll('input');
        const qty = parseFloat(inputs[1].value) || 0;
        const price = parseFloat(inputs[2].value) || 0;
        subtotal += qty * price;
      });
      
      const tax = nights * adults * 5;
      const cleaning = parseFloat(document.getElementById('invoiceCleaning').value) || 70;
      const total = subtotal + tax + cleaning;
      const deposit = parseFloat(document.getElementById('invoiceDeposit').value) || 0;
      const balance = total - deposit;
      
      document.getElementById('invoiceSubtotal').value = subtotal.toFixed(2);
      document.getElementById('invoiceTax').value = tax.toFixed(2);
      document.getElementById('invoiceTotal').value = total.toFixed(2);
      document.getElementById('invoiceBalance').value = balance.toFixed(2);
    }

    function addInvoiceItem() {
      const container = document.getElementById('invoiceItems');
      const div = document.createElement('div');
      div.className = 'form-row';
      div.style.marginBottom = '8px';
      div.innerHTML = `
        <input type="text" class="form-input" placeholder="Beschreibung" style="flex:2;">
        <input type="number" class="form-input" placeholder="Menge" value="1" style="width:80px;" onchange="calculateInvoice()">
        <input type="number" class="form-input" placeholder="Preis" value="0" step="0.01" style="width:100px;" onchange="calculateInvoice()">
        <button class="btn btn-danger" style="padding:8px;" onclick="this.parentElement.remove();calculateInvoice();">√ó</button>
      `;
      container.appendChild(div);
    }

    async function saveInvoice() {
      const items = [];
      document.querySelectorAll('#invoiceItems .form-row').forEach(row => {
        const inputs = row.querySelectorAll('input');
        items.push({
          description: inputs[0].value,
          quantity: parseFloat(inputs[1].value) || 1,
          price: parseFloat(inputs[2].value) || 0
        });
      });
      
      const data = {
        booking_id: document.getElementById('invoiceBooking').value || null,
        guest_name: document.getElementById('invoiceGuest').value,
        email: document.getElementById('invoiceEmail').value,
        checkin: document.getElementById('invoiceCheckin').value,
        checkout: document.getElementById('invoiceCheckout').value,
        adults: parseInt(document.getElementById('invoiceAdults').value) || 2,
        children: parseInt(document.getElementById('invoiceChildren').value) || 0,
        items: items,
        subtotal: parseFloat(document.getElementById('invoiceSubtotal').value) || 0,
        tax: parseFloat(document.getElementById('invoiceTax').value) || 0,
        cleaning_fee: parseFloat(document.getElementById('invoiceCleaning').value) || 70,
        total: parseFloat(document.getElementById('invoiceTotal').value) || 0,
        deposit: parseFloat(document.getElementById('invoiceDeposit').value) || 0,
        balance_due: parseFloat(document.getElementById('invoiceBalance').value) || 0,
        status: 'pending'
      };
      
      try {
        await fetch('/api/invoices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        closeModal('invoiceModal');
        await loadInvoices();
        renderPendingInvoices();
        alert('Rechnung erstellt!');
      } catch (e) {
        alert('Fehler: ' + e.message);
      }
    }

    function sendEmailForBooking(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;
      
      const template = emailTemplates.find(t => t.template_type === 'booking');
      if (!template) {
        alert('Keine E-Mail Vorlage gefunden');
        return;
      }
      
      let body = template.body
        .replace(/\{\{guest_name\}\}/g, booking.guest_name || 'Gast')
        .replace(/\{\{checkin\}\}/g, formatDate(booking.start_date))
        .replace(/\{\{checkout\}\}/g, formatDate(booking.end_date))
        .replace(/\{\{adults\}\}/g, booking.adults || 2)
        .replace(/\{\{children\}\}/g, booking.children || 0)
        .replace(/\{\{total\}\}/g, parseFloat(booking.amount || 0).toFixed(2))
        .replace(/\{\{deposit\}\}/g, (parseFloat(booking.amount || 0) * 0.3).toFixed(2))
        .replace(/\{\{deposit_due\}\}/g, formatDate(booking.start_date));
      
      document.getElementById('emailTo').value = booking.email || '';
      document.getElementById('emailSubject').value = template.subject.replace(/\{\{.*?\}\}/g, '');
      document.getElementById('emailBody').textContent = body;
      document.getElementById('emailModalTitle').textContent = template.name;
      openModal('emailModal');
    }

    function previewTemplate(templateId) {
      const template = emailTemplates.find(t => t.id === templateId);
      if (!template) return;
      
      document.getElementById('emailTo').value = '';
      document.getElementById('emailSubject').value = template.subject;
      document.getElementById('emailBody').textContent = template.body;
      document.getElementById('emailModalTitle').textContent = template.name + ' (Vorschau)';
      openModal('emailModal');
    }

    function copyEmail() {
      const subject = document.getElementById('emailSubject').value;
      const body = document.getElementById('emailBody').textContent;
      const text = `Betreff: ${subject}\n\n${body}`;
      
      navigator.clipboard.writeText(text).then(() => {
        alert('E-Mail in Zwischenablage kopiert!');
      });
    }

    function downloadInvoicePDF(invoiceId) {
      const invoice = invoices.find(i => i.id === invoiceId);
      if (!invoice) return;
      
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.text('RECHNUNG', 20, 25);
      
      doc.setFontSize(10);
      doc.text('Chalet Bischof', 140, 20);
      doc.text('Dorfstra√üe 123', 140, 26);
      doc.text('6020 Innsbruck, √ñsterreich', 140, 32);
      
      doc.setFontSize(12);
      doc.text(`Rechnungsnummer: ${invoice.invoice_number}`, 20, 50);
      doc.text(`Datum: ${formatDate(invoice.created_at)}`, 20, 58);
      
      doc.text('Rechnungsempf√§nger:', 20, 75);
      doc.setFontSize(10);
      doc.text(invoice.guest_name || 'Gast', 20, 83);
      if (invoice.address) doc.text(invoice.address, 20, 89);
      
      doc.setFontSize(10);
      doc.text(`Aufenthalt: ${formatDate(invoice.checkin)} - ${formatDate(invoice.checkout)}`, 20, 105);
      doc.text(`Personen: ${invoice.adults} Erwachsene, ${invoice.children} Kinder`, 20, 112);
      
      let y = 130;
      doc.setFontSize(10);
      doc.text('Beschreibung', 20, y);
      doc.text('Betrag', 160, y);
      y += 8;
      doc.line(20, y, 190, y);
      y += 8;
      
      const items = typeof invoice.items === 'string' ? JSON.parse(invoice.items) : (invoice.items || []);
      items.forEach(item => {
        doc.text(item.description || 'Position', 20, y);
        doc.text(`‚Ç¨${(item.quantity * item.price).toFixed(2)}`, 160, y);
        y += 8;
      });
      
      doc.text('Ortstaxe', 20, y);
      doc.text(`‚Ç¨${parseFloat(invoice.tax || 0).toFixed(2)}`, 160, y);
      y += 8;
      
      doc.text('Endreinigung', 20, y);
      doc.text(`‚Ç¨${parseFloat(invoice.cleaning_fee || 70).toFixed(2)}`, 160, y);
      y += 8;
      
      doc.line(20, y, 190, y);
      y += 8;
      
      doc.setFontSize(12);
      doc.text('Gesamtbetrag:', 20, y);
      doc.text(`‚Ç¨${parseFloat(invoice.total || 0).toFixed(2)}`, 160, y);
      y += 8;
      
      doc.setFontSize(10);
      doc.text(`Anzahlung: ‚Ç¨${parseFloat(invoice.deposit || 0).toFixed(2)}`, 20, y);
      y += 6;
      doc.text(`Restbetrag: ‚Ç¨${parseFloat(invoice.balance_due || 0).toFixed(2)}`, 20, y);
      
      doc.save(`Rechnung_${invoice.invoice_number.replace('/', '-')}.pdf`);
    }

    init();
  </script>
</body>
</html>
